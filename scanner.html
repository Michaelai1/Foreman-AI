<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Tracking - Scanner</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Tool Tracking System</h1>
            <nav>
                <a href="index.html">Logout</a>
            </nav>
        </header>
        
        <main>
            <div class="scanner-card">
                <h2>Tool Action</h2>
                <img id="toolImage" src="" alt="Tool Image">
                <p id="toolInfo"></p>
                <p id="crewInfo"></p>
                <div class="scanner-actions">
                    <button id="checkOutButton" class="btn btn-primary">Check Out</button>
                    <button id="checkInButton" class="btn btn-secondary">Check In</button>
                </div>
                <div class="view-tools-section">
                    <button id="viewMyToolsButton" class="btn btn-outline">View my checked out tools</button>
                    <div id="crewToolsResults" class="tools-results" style="display: none;"></div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>&copy; 2025 Tool Tracking Demo</p>
        </footer>
    </div>
    
    <script>
        // Store tool_id for use in button handlers
        let currentToolId = null;
        const webhookUrl = 'https://michaelcarey.app.n8n.cloud/webhook/16b143ea-d39f-4e9c-bedd-91cff4d0d611';
        
        // Map tool IDs to actual image filenames
        function getImageFilename(toolId) {
            if (!toolId) return null;
            
            // Normalize tool_id to handle different formats
            const normalized = toolId.toUpperCase().trim();
            
            // Map tool IDs to actual filenames
            const imageMap = {
                'BUCKET': 'Bucket.png',
                'GENERATOR': 'Generator.png',
                'LADDER': 'Ladder.png',
                'RIGCHAIN': 'Rig Chain.png',
                'RIG_CHAIN': 'Rig Chain.png',
                'RIG-CHAIN': 'Rig Chain.png',
                'SAW': 'Saw.png'
            };
            
            // Check direct match first
            if (imageMap[normalized]) {
                return imageMap[normalized];
            }
            
            // Try case-insensitive match for other variations
            for (const [key, value] of Object.entries(imageMap)) {
                if (normalized === key || normalized.replace(/[_-]/g, '') === key.replace(/[_-]/g, '')) {
                    return value;
                }
            }
            
            // Fallback: try capitalized version
            return toolId.charAt(0).toUpperCase() + toolId.slice(1).toLowerCase() + '.png';
        }
        
        // Function to search Airtable for tool information
        async function searchToolInAirtable(toolId) {
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                    },
                    body: JSON.stringify({
                        action: 'search_tool',
                        tool_id: toolId
                    })
                });
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error searching tool:', error);
                return null;
            }
        }

        // On Page Load
        window.addEventListener('DOMContentLoaded', async function() {
            // Check if a crew ID exists in localStorage
            const loggedInCrew = localStorage.getItem('loggedInCrewId');
            
            // Get the tool_id from the current URL's parameters
            const urlParams = new URLSearchParams(window.location.search);
            const toolId = urlParams.get('tool_id');
            const itemType = urlParams.get('type');
            
            if (loggedInCrew === null) {
                // If no crew is logged in, redirect to login page with redirectTool parameter
                if (toolId) {
                    window.location.href = 'index.html?redirectTool=' + toolId;
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                // Display the logged-in crew ID
                document.getElementById('crewInfo').textContent = 'Logged in as: ' + loggedInCrew;
                
                // Store tool_id for button handlers
                currentToolId = toolId;
                
                // Display the tool_id
                if (toolId) {
                    // Search Airtable for tool information
                    const toolData = await searchToolInAirtable(toolId);
                    
                    // Set image - prioritize Airtable photo_location, fallback to local mapping
                    if (toolData && toolData.photo_location) {
                        document.getElementById('toolImage').src = toolData.photo_location;
                    } else {
                        const imageFilename = getImageFilename(toolId);
                        if (imageFilename) {
                            document.getElementById('toolImage').src = imageFilename;
                        }
                    }
                    
                    // Display tool information
                    let toolInfoText = 'Tool ID: ' + toolId;
                    if (toolData) {
                        if (toolData.name) toolInfoText += '\nName: ' + toolData.name;
                        if (toolData.description) toolInfoText += '\nDescription: ' + toolData.description;
                        if (toolData.status) toolInfoText += '\nStatus: ' + toolData.status;
                        if (toolData.location) toolInfoText += '\nLocation: ' + toolData.location;
                    }
                    document.getElementById('toolInfo').textContent = toolInfoText;
                    
                    // Handle UI based on itemType
                    const scannerActionsDiv = document.querySelector('.scanner-actions');
                    const checkOutButton = document.getElementById('checkOutButton');
                    const checkInButton = document.getElementById('checkInButton');
                    
                    if (itemType === 'shareable') {
                        // Do nothing - existing UI with Check Out and Check In buttons is correct
                    } else if (itemType === 'consumable') {
                        // Hide Check Out and Check In buttons
                        checkOutButton.style.display = 'none';
                        checkInButton.style.display = 'none';
                        
                        // Set new innerHTML for consumable UI
                        scannerActionsDiv.innerHTML = `
                            <div class="form-group">
                                <input type="number" id="consumableQuantity" placeholder="Enter quantity" required>
                            </div>
                            <button id="takeConsumableButton" class="btn btn-primary">Take</button>
                        `;
                        
                        // Add event listener for takeConsumableButton
                        document.getElementById('takeConsumableButton').addEventListener('click', function() {
                            const quantity = document.getElementById('consumableQuantity').value;
                            const quantityNum = parseFloat(quantity);
                            
                            // Validate quantity
                            if (isNaN(quantityNum) || quantityNum <= 0) {
                                alert('Please enter a valid quantity.');
                                return;
                            }
                            
                            // Get currentToolId and loggedInCrew
                            const toolId = currentToolId;
                            const loggedInCrew = localStorage.getItem('loggedInCrewId');
                            
                            // Create data object
                            const data = {
                                tool_id: toolId,
                                crew_id: loggedInCrew,
                                quantity_taken: quantityNum,
                                action: 'take_consumable'
                            };
                            
                            // Send data to webhook
                            fetch(webhookUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                                },
                                body: JSON.stringify(data)
                            })
                            .then(response => response.json())
                            .then(data => {
                                alert('Consumable submitted!');
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Submission failed!');
                            });
                        });
                    } else {
                        // itemType is missing or invalid
                        document.getElementById('toolInfo').textContent = 'Error: Invalid QR Code Type.';
                        checkOutButton.style.display = 'none';
                        checkInButton.style.display = 'none';
                    }
                } else {
                    document.getElementById('toolInfo').textContent = 'Tool ID: Not specified';
                }
            }
        });
        
        // Button Event Listeners (only attach if buttons exist)
        const checkOutButton = document.getElementById('checkOutButton');
        const checkInButton = document.getElementById('checkInButton');
        
        if (checkOutButton) {
            checkOutButton.addEventListener('click', function() {
            const toolId = currentToolId;
            const loggedInCrew = localStorage.getItem('loggedInCrewId');
            
            if (!toolId || !loggedInCrew) {
                alert('Missing tool ID or crew ID');
                return;
            }
            
            // Prepare data
            const data = {
                tool_id: toolId,
                crew_id: loggedInCrew,
                action: 'checkout'
            };
            
            // Send data to webhook
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                alert('Checkout submitted!');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Checkout submitted!');
            });
        });
        }
        
        if (checkInButton) {
            checkInButton.addEventListener('click', function() {
            const toolId = currentToolId;
            const loggedInCrew = localStorage.getItem('loggedInCrewId');
            
            if (!toolId || !loggedInCrew) {
                alert('Missing tool ID or crew ID');
                return;
            }
            
            // Prepare data
            const data = {
                tool_id: toolId,
                crew_id: loggedInCrew,
                action: 'checkin'
            };
            
            // Send data to webhook
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                alert('Check-in submitted!');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Check-in submitted!');
            });
        }
        
        // View my checked out tools functionality
        document.getElementById('viewMyToolsButton').addEventListener('click', async function() {
            const loggedInCrew = localStorage.getItem('loggedInCrewId');
            const resultsDiv = document.getElementById('crewToolsResults');
            
            if (!loggedInCrew) {
                alert('Not logged in');
                return;
            }
            
            // Toggle visibility
            if (resultsDiv.style.display === 'none') {
                // Show loading state
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<p class="loading">Loading your tools...</p>';
                
                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                        },
                        body: JSON.stringify({
                            action: 'get_crew_tools',
                            crew_id: loggedInCrew
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.tools && data.tools.length > 0) {
                        let html = '<h3>Your Checked Out Tools</h3>';
                        html += '<div class="tools-list">';
                        data.tools.forEach(function(tool) {
                            html += '<div class="tool-item">';
                            html += '<div class="tool-name"><strong>' + (tool.name || tool.tool_id) + '</strong></div>';
                            if (tool.tool_id) html += '<div class="tool-id">ID: ' + tool.tool_id + '</div>';
                            if (tool.checked_out_date) html += '<div class="tool-date">Checked Out: ' + tool.checked_out_date + '</div>';
                            html += '</div>';
                        });
                        html += '</div>';
                        resultsDiv.innerHTML = html;
                    } else {
                        resultsDiv.innerHTML = '<p class="no-results">You have no tools currently checked out</p>';
                    }
                } catch (error) {
                    console.error('Error loading crew tools:', error);
                    resultsDiv.innerHTML = '<p class="error">Error loading tools. Please try again.</p>';
                }
            } else {
                // Hide the results
                resultsDiv.style.display = 'none';
            }
        });
    </script>
</body>
</html>
