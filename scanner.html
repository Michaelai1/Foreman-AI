<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Scanner</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Tool Tracking Portal</h1>
            <nav>
                <a href="#" id="logoutLink">Logout</a>
            </nav>
        </header>

        <main>
            <div class="scanner-card">
                <h2>Smart Tool Scanner</h2>
                <img id="toolImage" src="" alt="Tool Image" style="display: none; width: 100%; border-radius: 8px; margin-bottom: 20px;">
                <p id="toolInfo"><strong>Scanner Active</strong><br>Scan a tool QR code to get details.</p>
                <p style="font-size: 12px; color: #7f8c8d; margin-top: 6px;">Keep this page open in your browser to stay logged in.</p>
                <p id="crewInfo"></p>
                <div class="scanner-actions" id="scannerActions"></div>

                <button type="button" class="btn btn-secondary" id="viewMyToolsButton">View my checked out tools</button>
                <div id="crewToolsResults" style="margin-top: 20px;"></div>
            </div>
        </main>
    </div>

    <script>
        const webhookUrl = 'https://michaelcarey.app.n8n.cloud/webhook/db9aa8fb-be0c-4fe9-b3d8-52ea647a962f';

        document.addEventListener('DOMContentLoaded', () => {
            const crewInfo = document.getElementById('crewInfo');
            const toolInfo = document.getElementById('toolInfo');
            const toolImage = document.getElementById('toolImage');
            const scannerActions = document.getElementById('scannerActions');
            const viewMyToolsButton = document.getElementById('viewMyToolsButton');
            const crewToolsResults = document.getElementById('crewToolsResults');
            const logoutLink = document.getElementById('logoutLink');

            const params = new URLSearchParams(window.location.search);
            const toolId = params.get('tool_id');
            const crewId = localStorage.getItem('loggedInCrewId');

            if (!crewId) {
                // If not logged in, STOP and show the "TSW Property" message.
                document.querySelector('header').style.display = 'none'; // Hide the "Logout" button
                document.querySelector('.scanner-card').innerHTML = `
                    <h2>TSW Property</h2>
                    <p>This tool is the property of TSW.</p>
                    <p>If found, please call the tool manager at:</p>
                    <h3 style="margin-top: 15px;">[Tool Guy's Number Here]</h3>
                `;
                return; // Stop the rest of the script.
            }

            // If we're here, we ARE logged in.
            crewInfo.textContent = `Logged in Crew ID: ${crewId}`;

            if (toolId) {
                loadToolInfo(toolId, crewId);
            }

            logoutLink.addEventListener('click', (event) => {
                event.preventDefault();
                localStorage.removeItem('loggedInCrewId');
                window.location.href = 'index.html';
            });

            viewMyToolsButton.addEventListener('click', async () => {
                crewToolsResults.textContent = 'Loading...';
                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                        },
                        body: JSON.stringify({
                            action: 'get_crew_tools',
                            crew_id: crewId
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Unable to load tools.');
                    }

                    const data = await response.json();
                    renderCrewTools(data);
                } catch (error) {
                    console.error(error);
                    crewToolsResults.textContent = 'There was an issue fetching your tools. Please try again later.';
                }
            });

            function renderCrewTools(data) {
                if (!data || !Array.isArray(data.tools) || data.tools.length === 0) {
                    crewToolsResults.textContent = 'No tools currently checked out.';
                    return;
                }

                const list = document.createElement('ul');
                list.style.listStyle = 'none';
                list.style.padding = '0';

                data.tools.forEach((tool) => {
                    const item = document.createElement('li');
                    item.style.border = '1px solid #ddd';
                    item.style.borderRadius = '6px';
                    item.style.padding = '12px';
                    item.style.marginBottom = '10px';

                    const name = tool.name ? `${tool.name}` : 'Unknown Tool';
                    const id = tool.tool_id ? ` (${tool.tool_id})` : '';
                    const status = tool.status ? `Status: ${tool.status}` : '';
                    const dueDate = tool.due_date ? `Due: ${tool.due_date}` : '';

                    item.innerHTML = `
                        <strong>${name}${id}</strong><br>
                        ${status}<br>
                        ${dueDate}
                    `;
                    list.appendChild(item);
                });

                crewToolsResults.innerHTML = '';
                crewToolsResults.appendChild(list);
            }

            async function loadToolInfo(toolId, crewIdForActions) {
                toolInfo.textContent = 'Loading tool information...';
                scannerActions.innerHTML = '';
                toolImage.style.display = 'none';
                toolImage.removeAttribute('src');

                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                        },
                        body: JSON.stringify({
                            action: 'search_tool',
                            tool_id: toolId
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Unable to load tool information.');
                    }

                    const data = await response.json();
                    if (!data) {
                        toolInfo.textContent = 'No tool information found.';
                        return;
                    }

                    if (data.photo_location) {
                        toolImage.src = data.photo_location;
                        toolImage.style.display = 'block';
                    }

                    toolInfo.innerHTML = formatToolDetails(data);

                    if (data.type === 'shareable') {
                        createShareableActions(toolId, crewIdForActions);
                    } else if (data.type === 'consumable') {
                        createConsumableActions(toolId, crewIdForActions);
                    } else {
                        const message = document.createElement('p');
                        message.textContent = 'No actions available for this tool type.';
                        scannerActions.appendChild(message);
                    }
                } catch (error) {
                    console.error(error);
                    toolInfo.textContent = 'There was an error loading the tool. Please try again.';
                }
            }

            function formatToolDetails(data) {
                const details = Object.entries(data)
                    .filter(([key]) => key !== 'photo_location')
                    .map(([key, value]) => `<strong>${toTitleCase(key)}:</strong> ${value}`)
                    .join('<br>');
                return details || 'No additional tool information available.';
            }

            function toTitleCase(text) {
                return text
                    .replace(/_/g, ' ')
                    .replace(/\w\S*/g, (word) => word.charAt(0).toUpperCase() + word.slice(1));
            }

            function createShareableActions(toolId, crewIdForActions) {
                const checkOutButton = document.createElement('button');
                checkOutButton.className = 'btn btn-primary';
                checkOutButton.textContent = 'Check Out';

                const checkInButton = document.createElement('button');
                checkInButton.className = 'btn btn-secondary';
                checkInButton.textContent = 'Check In';

                checkOutButton.addEventListener('click', () => handleToolAction('checkout', { tool_id: toolId, crew_id: crewIdForActions }));
                checkInButton.addEventListener('click', () => handleToolAction('checkin', { tool_id: toolId, crew_id: crewIdForActions }));

                scannerActions.appendChild(checkOutButton);
                scannerActions.appendChild(checkInButton);
            }

            function createConsumableActions(toolId, crewIdForActions) {
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.placeholder = 'Quantity';
                quantityInput.style.width = '100%';
                quantityInput.style.marginBottom = '10px';
                quantityInput.style.padding = '12px';
                quantityInput.style.border = '1px solid #ddd';
                quantityInput.style.borderRadius = '4px';

                const takeButton = document.createElement('button');
                takeButton.className = 'btn btn-primary';
                takeButton.textContent = 'Take';

                takeButton.addEventListener('click', () => {
                    const quantity = parseInt(quantityInput.value, 10);
                    if (!quantity || quantity <= 0) {
                        alert('Please enter a valid quantity.');
                        return;
                    }
                    handleToolAction('take_consumable', {
                        tool_id: toolId,
                        crew_id: crewIdForActions,
                        quantity_taken: quantity
                    });
                });

                scannerActions.appendChild(quantityInput);
                scannerActions.appendChild(takeButton);
            }

            async function handleToolAction(action, payload) {
                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                        },
                        body: JSON.stringify({
                            action,
                            ...payload
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Action failed.');
                    }

                    const data = await response.json();
                    alert(data.message || 'Action completed successfully.');
                } catch (error) {
                    console.error(error);
                    alert('There was a problem processing the action. Please try again.');
                }
            }
        });
    </script>
</body>
</html>

