<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Tracking - Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Tool Tracking System</h1>
        </header>
        
        <main>
            <div class="login-card">
                <h2>Crew Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <input type="text" id="crewIdInput" placeholder="Enter Crew ID" required autofocus>
                    </div>
                    <button type="submit" id="loginButton" class="btn btn-primary">Login</button>
                </form>
            </div>
        </main>
        
        <footer>
            <p>&copy; 2025 Tool Tracking Demo</p>
        </footer>
    </div>
    
    <script>
        const webhookUrl = 'https://michaelcarey.app.n8n.cloud/webhook/9de1e638-d13d-4fb1-9c5e-3bfab060e53e';
        
        // Login functionality
        document.getElementById('loginButton').addEventListener('click', async function(e) {
            e.preventDefault();
            
            // Get the value entered into crewIdInput
            const crewId = document.getElementById('crewIdInput').value.trim();
            
            if (!crewId) {
                alert('Please enter a Crew ID');
                return;
            }
            
            // Verify crew exists in Airtable
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-N8N-API-KEY': 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
                    },
                    body: JSON.stringify({
                        action: 'verify_crew',
                        crew_id: crewId
                    })
                });
                
                const data = await response.json();
                
                if (data.valid || data.exists) {
                    // Store the ID in localStorage
                    localStorage.setItem('loggedInCrewId', crewId);
                    
                    // Check if the current URL has a redirectTool parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectTool = urlParams.get('redirectTool');
                    
                    // Redirect based on redirectTool parameter
                    if (redirectTool) {
                        window.location.href = 'scanner.html?tool_id=' + redirectTool;
                    } else {
                        window.location.href = 'scanner.html';
                    }
                } else {
                    // Show alert for invalid Crew ID
                    alert('Invalid Crew ID');
                }
            } catch (error) {
                console.error('Error verifying crew:', error);
                // Fallback: allow login if webhook fails (for offline use)
                localStorage.setItem('loggedInCrewId', crewId);
                const urlParams = new URLSearchParams(window.location.search);
                const redirectTool = urlParams.get('redirectTool');
                if (redirectTool) {
                    window.location.href = 'scanner.html?tool_id=' + redirectTool;
                } else {
                    window.location.href = 'scanner.html';
                }
            }
        });
        
    </script>
</body>
</html>
